<html>

<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
</head>
<style>
    .county {
        fill: gray;
        stroke: none;
    }

    .state {
        fill: gray;
    }

    .outline {
        fill: none;
        stroke: black;
        stroke-width: 2px;
    }

    .statemap {
        fill: white;
    }

    .county-outline {
        fill: none;
        stroke: black;
        stroke-width: 1px
    }
</style>

<body>
    <svg id="usmap" height="600" width="900" style="margin:20px"></svg>
    <svg id="statemap" height="500" width="500" style="margin:20px"></svg>
    <div id="button-bar"></div>
    
    <script>
        // VISUALIZATION 1 - map of US with health care spending for each state
        const svg1 = d3.select('svg#usmap');
        const width1 = svg1.attr('width');
        const height1 = svg1.attr('height');
        const margins1 = { top: 20, right: 20, bottom: 20, left: 20 };
        const mapWidth1 = width1 - margins1.left - margins1.right;
        const mapHeight1 = height1 - margins1.top - margins1.bottom;
        const usmap = svg1.append("g")
            .attr("transform", "translate(" + margins1.left + "," + margins1.top + ")");

        // VISUALIZATION 2 - covid cases by county
        const svg2 = d3.select('svg#statemap');
        const width2 = svg2.attr('width');
        const height2 = svg2.attr('height');
        const margins2 = { top: 20, right: 20, bottom: 20, left: 20 };
        const mapWidth2 = width2 - margins2.left - margins2.right;
        const mapHeight2 = height2 - margins2.top - margins2.bottom;
        const statemap = svg2.append("g")
            .attr("transform", "translate(" + margins2.left + "," + margins2.top + ")");

        const requestData = async function () {
            // import topoJSON for US map
            const us = await d3.json("us-counties.json");
            console.log(us);

            // VISUALIZATION 1
            // draw US map
            var states = topojson.feature(us, us.objects.states);
            var statesMesh = topojson.mesh(us, us.objects.states);
            var projection1 = d3.geoAlbersUsa().fitSize([mapWidth1, mapHeight1], states);
            var path1 = d3.geoPath().projection(projection1);

            // state paths
            let statePaths = usmap.selectAll("path.state").data(states.features)
                .join("path")
                .attr("class", "state")
                .attr("d", path1)
                .on('mouseover', mouseoverState)
                .on('mouseout', mouseoutState)
                .on('click', (event, d) => {
                    console.log(d);
                    updateStateMap(d);
                });

            usmap.append("path").datum(statesMesh)
                .attr("class", "outline")
                .attr("d", path1);

            // import health spending data
            const healthSpendingData = await d3.csv("health_spending_data.csv");
            const hsc = 'Health Spending per Capita'
            healthSpendingData.forEach((d, i) => {
                d[hsc] = d[hsc].replace(/[$, ]/g, "").trim();
                d[hsc] = Number(d[hsc]);
            })
            console.log(healthSpendingData)

            // import COVID data
            const covidData = await d3.csv("us-counties-2020.csv", d3.autoType);

            // build quantile color scale for coloring the states by health spending

            // color the states using the color scale (replace white)
            
            // 
            var healthSpendingDict = {};
            healthSpendingData.forEach(d => {
                const spending = parseFloat(d["Health Spending per Capita"]);
                healthSpendingDict[d.Location] = { total: spending };
            });

            var covidDeathsDict = {};
            covidData.forEach( d => {

                if (d.state in covidDeathsDict) {
                    covidDeathsDict[d.state]= { total: (covidDeathsDict[d.state].total + d.deaths)}
                } else {
                    covidDeathsDict[d.state]={ total: d.deaths}
                }
            });

            console.log(covidDeathsDict)

            var usData = [healthSpendingDict, covidDeathsDict];
            function updateUsScale(usToggle) {
                let stateDict = usData[usToggle];
                console.log(stateDict);

                const colorScale = d3.scaleQuantile()
                    .domain(Object.values(stateDict).map(d => d.total))
                    .range(["#fff", "#d1e8ed", "#adc2da", "#8879b3", "#762b80"]);

                usmap.selectAll(".state")
                    .style("fill", d => {
                        const stateName = d.properties.name;
                        if (stateDict[stateName]) {
                            return colorScale(stateDict[stateName].total);
                        } else {
                            return "#ccc";
                        }
                });
            }
            // buttons for map of US toggle
            const usKeys = Object.keys(usData);
            usKeys.forEach( d => {
                d3.select("div#button-bar")
                  .append("button")
                  .text( d )
                  .on("click", function() {
                    updateUsScale( d );
                  })
            })

            // write mouseoverState function to show name of state and amount of money on mouseover
            function mouseoverState() {
                let state = d3.select(this);

                state.attr("stroke", "black")
                    .attr("stroke-width", 3);
            }
            // write mouseoutState function to get rid of label 
            function mouseoutState() {
                let state = d3.select(this);
                state.attr("stroke", "none")
                    .attr("stroke-width", 0);
            }

            // make legend for the color scale 


            // VISUALIZATION 2

            

            // write updateState function to update map 2 with county-level COVID data for selected state
            function updateStateMap(selectedState) {
                // isolate counties for selected state
                let selectedCounties = us.objects.counties.geometries.filter(function (d) { return selectedState.id == Math.floor(d.id / 1000) });
                var counties = topojson.feature(us, { type: "GeometryCollection", geometries: selectedCounties });
                var countiesMesh = topojson.mesh(us, { type: "GeometryCollection", geometries: selectedCounties });

                // create projection & path for selected state
                var stateProjection = d3.geoAlbersUsa().fitSize([mapWidth2, mapHeight2], selectedState);
                var statePath = d3.geoPath().projection(stateProjection);

                // Draw individual state outline
                statemap.append("path").datum(selectedState)
                    .attr("class", "outline")
                    .attr("d", statePath);

                // Draw counties within the selected state
                statemap.selectAll("path.county").data(counties.features)
                    .join("path")
                    .attr("class", "county")
                    .attr("d", statePath);

                statemap.append("path").datum(countiesMesh)
                    .attr("class", "county-outline")
                    .attr("d", statePath);

            }




        }
        requestData();
    </script>
</body>

</html>